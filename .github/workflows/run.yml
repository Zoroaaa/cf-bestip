name: CF IP Multi-Region Scanner V2

on:
  schedule:
    - cron: "0 */8 * * *"  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä»…è¿è¡Œå†…éƒ¨æµ‹è¯•ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl --version

      - name: Create requirements.txt
        run: |
          cat > requirements.txt << EOF
          requests>=2.31.0
          beautifulsoup4>=4.12.0
          lxml>=4.9.0
          EOF

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip list

      - name: Verify dependencies
        run: |
          python -c "import requests; print(f'requests: {requests.__version__}')"
          python -c "import bs4; print(f'beautifulsoup4: {bs4.__version__}')"
          python -c "import subprocess; print('subprocess: OK')"

      - name: Create output directories
        run: |
          mkdir -p public/data
          ls -la

      - name: Run internal tests
        id: test
        run: |
          python << 'EOF'
          import sys
          sys.path.insert(0, '.')
          
          # å¯¼å…¥å¹¶è¿è¡Œæµ‹è¯•
          try:
              from tests import run_internal_tests
              
              print("ğŸ” å¼€å§‹è¿è¡Œå†…éƒ¨æµ‹è¯•...")
              result = run_internal_tests()
              
              if result:
                  print("âœ… å†…éƒ¨æµ‹è¯•é€šè¿‡")
                  sys.exit(0)
              else:
                  print("âš ï¸ å†…éƒ¨æµ‹è¯•éƒ¨åˆ†å¤±è´¥ï¼Œä½†å…è®¸ç»§ç»­")
                  sys.exit(0)  # å…è®¸éƒ¨åˆ†å¤±è´¥
          except Exception as e:
              print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF
        continue-on-error: false

      - name: Run multi-region scan
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œå¤šåœ°åŒºæ‰«æ..."
          python ip.py
        env:
          PYTHONUNBUFFERED: "1"
          PYTHONDONTWRITEBYTECODE: "1"
          WEBSHARE_TOKEN: ${{ secrets.WEBSHARE_TOKEN }}
        timeout-minutes: 90

      - name: Verify output files
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "ğŸ“ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
          ls -lh public/
          
          echo ""
          echo "=== æ ¸å¿ƒæ–‡ä»¶æ£€æŸ¥ ==="
          
          # æ£€æŸ¥ IP æ€»åˆ—è¡¨
          if [ -f "public/ip_all.txt" ]; then
            echo "âœ… ip_all.txt å­˜åœ¨"
            LINE_COUNT=$(wc -l < public/ip_all.txt)
            echo "   æ€»è¡Œæ•°: $LINE_COUNT"
          else
            echo "âŒ ip_all.txt ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ä»£ç†æ€»åˆ—è¡¨
          if [ -f "public/proxy_all.txt" ]; then
            echo "âœ… proxy_all.txt å­˜åœ¨"
            PROXY_COUNT=$(wc -l < public/proxy_all.txt)
            echo "   æ€»è¡Œæ•°: $PROXY_COUNT"
          else
            echo "âš ï¸ proxy_all.txt ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ JSON
          if [ -f "public/ip_candidates.json" ]; then
            echo "âœ… ip_candidates.json å­˜åœ¨"
            echo "   é¢„è§ˆå†…å®¹:"
            cat public/ip_candidates.json | python -m json.tool | head -30
          else
            echo "âŒ ip_candidates.json ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ HTML (ä¿®å¤ stat å‘½ä»¤)
          if [ -f "public/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            SIZE=$(stat -c%s public/index.html 2>/dev/null || echo "unknown")
            echo "   æ–‡ä»¶å¤§å°: $SIZE bytes"
          else
            echo "âŒ index.html ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "=== å„åœ°åŒºæ–‡ä»¶ç»Ÿè®¡ ==="
          
          # ç»Ÿè®¡ IP æ–‡ä»¶
          echo "ğŸ“ IP æ–‡ä»¶:"
          for file in public/ip_*.txt; do
            if [ -f "$file" ] && [ "$file" != "public/ip_all.txt" ]; then
              filename=$(basename "$file")
              count=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "  $filename: $count è¡Œ"
            fi
          done
          
          # ç»Ÿè®¡ä»£ç†æ–‡ä»¶
          echo ""
          echo "ğŸ”‘ ä»£ç†æ–‡ä»¶:"
          for file in public/proxy_*.txt; do
            if [ -f "$file" ] && [ "$file" != "public/proxy_all.txt" ]; then
              filename=$(basename "$file")
              count=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "  $filename: $count è¡Œ"
            fi
          done

      - name: Validate HTML output
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "ğŸ” éªŒè¯ HTML æ–‡ä»¶..."
          
          if [ ! -f "public/index.html" ]; then
            echo "âŒ index.html ä¸å­˜åœ¨ï¼Œå°è¯•æ£€æŸ¥åŸå› ..."
            ls -la public/
            exit 1
          fi
          
          # æ£€æŸ¥ HTML æ–‡ä»¶æ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "Cloudflare IP ä¼˜é€‰" public/index.html; then
            echo "âœ… HTML æ ‡é¢˜æ­£ç¡®"
          else
            echo "âš ï¸ HTML æ ‡é¢˜å¯èƒ½ä¸æ­£ç¡®"
          fi
          
          if grep -q "region-card" public/index.html; then
            echo "âœ… HTML åŒ…å«åœ°åŒºå¡ç‰‡"
          else
            echo "âš ï¸ HTML å¯èƒ½ç¼ºå°‘åœ°åŒºå¡ç‰‡"
          fi
          
          if grep -q "proxy-item" public/index.html; then
            echo "âœ… HTML åŒ…å«ä»£ç†ä¿¡æ¯"
          else
            echo "âš ï¸ HTML å¯èƒ½ç¼ºå°‘ä»£ç†ä¿¡æ¯"
          fi
          
          # æ˜¾ç¤º HTML æ–‡ä»¶å¤§å° (ä¿®å¤ stat å‘½ä»¤)
          SIZE=$(stat -c%s public/index.html 2>/dev/null || echo "unknown")
          echo "ğŸ“Š HTML æ–‡ä»¶å¤§å°: $SIZE bytes"

      - name: Create .nojekyll
        if: github.event.inputs.test_mode != 'true'
        run: |
          touch public/.nojekyll
          echo "âœ… .nojekyll åˆ›å»ºæˆåŠŸ"

      - name: Upload artifacts
        if: always() && github.event.inputs.test_mode != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            public/
            !public/data/
          retention-days: 7
          compression-level: 9

      - name: Generate summary
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "## ğŸ“Š æ‰«æç»“æœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "public/ip_candidates.json" ]; then
            python << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          from datetime import datetime
          
          try:
              with open('public/ip_candidates.json', 'r') as f:
                  data = json.load(f)
              
              meta = data.get('meta', {})
              regions = meta.get('regions', {})
              nodes = data.get('nodes', [])
              
              print(f"### âœ… æ‰«ææˆåŠŸå®Œæˆ")
              print("")
              print(f"**ç”Ÿæˆæ—¶é—´**: {meta.get('generated_at', 'N/A')}")
              print(f"**ç‰ˆæœ¬**: {meta.get('version', 'N/A')}")
              print(f"**æµ‹è¯•åŸŸå**: {meta.get('test_domain', 'N/A')}")
              print("")
              print(f"### ğŸ“ˆ ç»Ÿè®¡æ•°æ®")
              print("")
              print(f"- ğŸŒ **æ€»èŠ‚ç‚¹æ•°**: {meta.get('total_nodes', 0)}")
              print(f"- ğŸ”‘ **æ€»ä»£ç†æ•°**: {meta.get('total_proxies', 0)}")
              print(f"- ğŸ“ **è¦†ç›–åœ°åŒº**: {len(regions)}")
              print("")
              print("### ğŸ—ºï¸ å„åœ°åŒºèŠ‚ç‚¹åˆ†å¸ƒ")
              print("")
              print("| åœ°åŒºä»£ç  | èŠ‚ç‚¹æ•° | ä»£ç†æ•° |")
              print("|---------|--------|--------|")
              
              # è¯»å–ä»£ç†æ–‡ä»¶ç»Ÿè®¡
              import os
              for region, count in sorted(regions.items(), key=lambda x: x[1], reverse=True):
                  proxy_file = f'public/proxy_{region}.txt'
                  proxy_count = 0
                  if os.path.exists(proxy_file):
                      with open(proxy_file, 'r') as pf:
                          proxy_count = len(pf.readlines())
                  print(f"| {region} | {count} | {proxy_count} |")
              
              print("")
              print("### ğŸ† Top 10 èŠ‚ç‚¹")
              print("")
              print("| æ’å | IP:ç«¯å£ | åœ°åŒº | COLO | è¯„åˆ† | å»¶è¿Ÿ |")
              print("|------|---------|------|------|------|------|")
              
              for i, node in enumerate(nodes[:10], 1):
                  latencies = node.get('latencies', [])
                  avg_lat = f"{sum(latencies)/len(latencies):.0f}ms" if latencies else "N/A"
                  print(f"| {i} | `{node['ip']}:{node['port']}` | {node['region']} | {node.get('colo', 'N/A')} | {node['score']:.4f} | {avg_lat} |")
              
              print("")
              print("### ğŸ“¥ ä¸‹è½½é“¾æ¥")
              print("")
              print("- [å…¨éƒ¨IPåˆ—è¡¨](ip_all.txt)")
              print("- [å…¨éƒ¨ä»£ç†åˆ—è¡¨](proxy_all.txt)")
              print("- [JSONæ•°æ®](ip_candidates.json)")
              print("- [ç½‘é¡µç‰ˆ](index.html)")
              
          except Exception as e:
              print(f"### âŒ è¯»å–ç»“æœå¤±è´¥")
              print(f"")
              print(f"é”™è¯¯ä¿¡æ¯: {e}")
              import traceback
              print(f"")
              print(f"```")
              print(traceback.format_exc())
              print(f"```")
          EOF
          else
            echo "### âš ï¸ æœªæ‰¾åˆ°æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "JSON æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ‰«æè¿‡ç¨‹æ˜¯å¦æ­£å¸¸æ‰§è¡Œã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Publish to GitHub Pages
        if: github.event.inputs.test_mode != 'true' && success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true
          commit_message: 'Deploy: Run #${{ github.run_number }} - ${{ github.event.head_commit.message }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Clean old artifacts
        if: github.event.inputs.test_mode != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const days = 7;
            const maxArtifacts = 10;
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            
            let deleted = 0;
            const sorted = artifacts.data.artifacts.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );
            
            for (const [index, artifact] of sorted.entries()) {
              if (index >= maxArtifacts || new Date(artifact.created_at) < cutoff) {
                console.log(`Deleting artifact: ${artifact.name} (${artifact.created_at})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                deleted++;
              }
            }
            
            console.log(`Deleted ${deleted} old artifacts`);

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
            echo ""
            echo "ğŸ“Š ç»“æœæ‘˜è¦:"
            
            if [ -f "public/ip_all.txt" ]; then
              IP_COUNT=$(wc -l < public/ip_all.txt)
              echo "  - IPèŠ‚ç‚¹: $IP_COUNT"
            fi
            
            if [ -f "public/proxy_all.txt" ]; then
              PROXY_COUNT=$(wc -l < public/proxy_all.txt)
              echo "  - ä»£ç†èŠ‚ç‚¹: $PROXY_COUNT"
            fi
            
            if [ -f "public/index.html" ]; then
              echo "  - HTMLé¡µé¢: âœ… å·²ç”Ÿæˆ"
            fi
            
            echo ""
            echo "ğŸŒ è®¿é—®: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
            echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
          fi
