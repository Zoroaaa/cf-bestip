name: CF IP Multi-Region Scanner V2

on:
  schedule:
    - cron: "0 */8 * * *"  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä»…è¿è¡Œå†…éƒ¨æµ‹è¯•ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # å¢åŠ è¶…æ—¶æ—¶é—´ä»¥é€‚åº”ä¸‰æ•°æ®æº

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # æµ…å…‹éš†ä»¥èŠ‚çœæ—¶é—´

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl --version

      - name: Create requirements.txt
        run: |
          cat > requirements.txt << EOF
          requests>=2.31.0
          beautifulsoup4>=4.12.0
          lxml>=4.9.0
          EOF

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip list

      - name: Verify dependencies
        run: |
          python -c "import requests; print(f'requests: {requests.__version__}')"
          python -c "import bs4; print(f'beautifulsoup4: {bs4.__version__}')"
          python -c "import subprocess; print('subprocess: OK')"

      - name: Create output directories
        run: |
          mkdir -p public/data
          ls -la

      - name: Run internal tests
        id: test
        run: |
          python << 'EOF'
          import sys
          sys.path.insert(0, '.')
          
          # å¯¼å…¥å¹¶è¿è¡Œæµ‹è¯•
          try:
              # è¿™é‡Œå¯ä»¥æ·»åŠ ç‹¬ç«‹çš„æµ‹è¯•è„šæœ¬
              # æˆ–è€…ç›´æ¥è¿è¡Œ ip.py ä¸­çš„æµ‹è¯•å‡½æ•°
              print("âœ… å†…éƒ¨æµ‹è¯•å‡†å¤‡å°±ç»ª")
              sys.exit(0)
          except Exception as e:
              print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
              sys.exit(1)
          EOF
        continue-on-error: false

      - name: Run multi-region scan
        if: github.event.inputs.test_mode != 'true'
        run: |
          python ip.py
        env:
          PYTHONUNBUFFERED: "1"
          PYTHONDONTWRITEBYTECODE: "1"
        timeout-minutes: 100

      - name: Verify output files
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "ğŸ“ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
          ls -lh public/
          
          if [ -f "public/ip_all.txt" ]; then
            echo "âœ… ip_all.txt å­˜åœ¨"
            wc -l public/ip_all.txt
          else
            echo "âš ï¸ ip_all.txt ä¸å­˜åœ¨"
          fi
          
          if [ -f "public/ip_candidates.json" ]; then
            echo "âœ… ip_candidates.json å­˜åœ¨"
            cat public/ip_candidates.json | python -m json.tool | head -20
          else
            echo "âš ï¸ ip_candidates.json ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ“Š å„åœ°åŒºæ–‡ä»¶ç»Ÿè®¡:"
          for file in public/ip_*.txt; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              count=$(wc -l < "$file")
              echo "  $filename: $count è¡Œ"
            fi
          done

      - name: Generate index.html
        if: github.event.inputs.test_mode != 'true'
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime
          
          # è¯»å– JSON æ•°æ®
          try:
              with open('public/ip_candidates.json', 'r') as f:
                  data = json.load(f)
          except:
              data = {"meta": {}, "nodes": []}
          
          meta = data.get('meta', {})
          nodes = data.get('nodes', [])[:50]  # æ˜¾ç¤ºå‰50ä¸ª
          
          html = f'''<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Cloudflare IP ä¼˜é€‰ç»“æœ</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }}
                  .container {{
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 16px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      overflow: hidden;
                  }}
                  .header {{
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }}
                  .header h1 {{ font-size: 2.5em; margin-bottom: 10px; }}
                  .header p {{ opacity: 0.9; font-size: 1.1em; }}
                  .meta {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      padding: 30px 40px;
                      background: #f8f9fa;
                      border-bottom: 2px solid #e9ecef;
                  }}
                  .meta-item {{
                      text-align: center;
                      padding: 15px;
                      background: white;
                      border-radius: 8px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }}
                  .meta-item .label {{
                      color: #6c757d;
                      font-size: 0.9em;
                      margin-bottom: 8px;
                  }}
                  .meta-item .value {{
                      color: #667eea;
                      font-size: 1.8em;
                      font-weight: bold;
                  }}
                  .downloads {{
                      padding: 30px 40px;
                      background: #f8f9fa;
                  }}
                  .downloads h2 {{
                      color: #333;
                      margin-bottom: 20px;
                      font-size: 1.5em;
                  }}
                  .download-grid {{
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                      gap: 15px;
                  }}
                  .download-btn {{
                      display: block;
                      padding: 12px 20px;
                      background: white;
                      color: #667eea;
                      text-decoration: none;
                      border-radius: 8px;
                      text-align: center;
                      font-weight: 600;
                      transition: all 0.3s;
                      border: 2px solid #667eea;
                  }}
                  .download-btn:hover {{
                      background: #667eea;
                      color: white;
                      transform: translateY(-2px);
                      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                  }}
                  .nodes {{
                      padding: 30px 40px;
                  }}
                  .nodes h2 {{
                      color: #333;
                      margin-bottom: 20px;
                      font-size: 1.5em;
                  }}
                  table {{
                      width: 100%;
                      border-collapse: collapse;
                  }}
                  th, td {{
                      padding: 12px;
                      text-align: left;
                      border-bottom: 1px solid #e9ecef;
                  }}
                  th {{
                      background: #667eea;
                      color: white;
                      font-weight: 600;
                      position: sticky;
                      top: 0;
                  }}
                  tr:hover {{ background: #f8f9fa; }}
                  .region-tag {{
                      display: inline-block;
                      padding: 4px 12px;
                      background: #667eea;
                      color: white;
                      border-radius: 12px;
                      font-size: 0.85em;
                      font-weight: 600;
                  }}
                  .score {{
                      color: #28a745;
                      font-weight: bold;
                  }}
                  .footer {{
                      padding: 20px 40px;
                      text-align: center;
                      color: #6c757d;
                      background: #f8f9fa;
                      border-top: 2px solid #e9ecef;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸŒ Cloudflare IP ä¼˜é€‰</h1>
                      <p>å¤šæ•°æ®æº | HTTPS + SOCKS5 | æ™ºèƒ½ç­›é€‰</p>
                  </div>
                  
                  <div class="meta">
                      <div class="meta-item">
                          <div class="label">æ€»èŠ‚ç‚¹æ•°</div>
                          <div class="value">{meta.get('total_nodes', 0)}</div>
                      </div>
                      <div class="meta-item">
                          <div class="label">æ•°æ®æº</div>
                          <div class="value">{len(meta.get('data_sources', []))}</div>
                      </div>
                      <div class="meta-item">
                          <div class="label">æ”¯æŒåè®®</div>
                          <div class="value">{len(meta.get('protocols', []))}</div>
                      </div>
                      <div class="meta-item">
                          <div class="label">æ›´æ–°æ—¶é—´</div>
                          <div class="value" style="font-size: 0.9em;">
                              {meta.get('generated_at', 'N/A')[:19].replace('T', ' ')}
                          </div>
                      </div>
                  </div>
                  
                  <div class="downloads">
                      <h2>ğŸ“¥ ä¸‹è½½æ–‡ä»¶</h2>
                      <div class="download-grid">
                          <a href="ip_all.txt" class="download-btn">ğŸŒ å…¨éƒ¨</a>
                          <a href="ip_HK.txt" class="download-btn">ğŸ‡­ğŸ‡° é¦™æ¸¯</a>
                          <a href="ip_SG.txt" class="download-btn">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡</a>
                          <a href="ip_JP.txt" class="download-btn">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</a>
                          <a href="ip_KR.txt" class="download-btn">ğŸ‡°ğŸ‡· éŸ©å›½</a>
                          <a href="ip_TW.txt" class="download-btn">ğŸ‡¹ğŸ‡¼ å°æ¹¾</a>
                          <a href="ip_US.txt" class="download-btn">ğŸ‡ºğŸ‡¸ ç¾å›½</a>
                          <a href="ip_DE.txt" class="download-btn">ğŸ‡©ğŸ‡ª å¾·å›½</a>
                          <a href="ip_UK.txt" class="download-btn">ğŸ‡¬ğŸ‡§ è‹±å›½</a>
                          <a href="ip_AU.txt" class="download-btn">ğŸ‡¦ğŸ‡º æ¾³å¤§åˆ©äºš</a>
                          <a href="ip_CA.txt" class="download-btn">ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§</a>
                          <a href="ip_candidates.json" class="download-btn">ğŸ“„ JSON</a>
                      </div>
                  </div>
                  
                  <div class="nodes">
                      <h2>ğŸ† Top 50 èŠ‚ç‚¹</h2>
                      <table>
                          <thead>
                              <tr>
                                  <th>#</th>
                                  <th>IP:ç«¯å£</th>
                                  <th>åœ°åŒº</th>
                                  <th>COLO</th>
                                  <th>è¯„åˆ†</th>
                                  <th>å»¶è¿Ÿ</th>
                              </tr>
                          </thead>
                          <tbody>
          '''
          
          for i, node in enumerate(nodes, 1):
              latencies = node.get('latencies', [])
              avg_latency = sum(latencies) / len(latencies) if latencies else 0
              
              html += f'''
                              <tr>
                                  <td>{i}</td>
                                  <td><code>{node['ip']}:{node['port']}</code></td>
                                  <td><span class="region-tag">{node['region']}</span></td>
                                  <td>{node.get('colo', 'N/A')}</td>
                                  <td class="score">{node['score']:.4f}</td>
                                  <td>{avg_latency:.0f}ms</td>
                              </tr>
              '''
          
          html += '''
                          </tbody>
                      </table>
                  </div>
                  
                  <div class="footer">
                      <p>ğŸ”„ æ¯8å°æ—¶è‡ªåŠ¨æ›´æ–° | æ•°æ®æº: Proxifly + ProxyDaily + Tomcat1235</p>
                      <p style="margin-top: 10px; font-size: 0.9em;">
                          <a href="https://github.com" style="color: #667eea; text-decoration: none;">GitHub</a> | 
                          Version 2.0
                      </p>
                  </div>
              </div>
          </body>
          </html>
          '''
          
          with open('public/index.html', 'w', encoding='utf-8') as f:
              f.write(html)
          
          print("âœ… index.html ç”ŸæˆæˆåŠŸ")
          EOF

      - name: Create .nojekyll
        if: github.event.inputs.test_mode != 'true'
        run: |
          touch public/.nojekyll
          echo "âœ… .nojekyll åˆ›å»ºæˆåŠŸ"

      - name: Upload artifacts
        if: always() && github.event.inputs.test_mode != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            public/
            !public/data/
          retention-days: 7
          compression-level: 9

      - name: Generate summary
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "## ğŸ“Š æ‰«æç»“æœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "public/ip_candidates.json" ]; then
            python << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          
          with open('public/ip_candidates.json', 'r') as f:
              data = json.load(f)
          
          meta = data.get('meta', {})
          regions = meta.get('regions', {})
          
          print(f"### æ€»èŠ‚ç‚¹æ•°: {meta.get('total_nodes', 0)}")
          print(f"### æ•°æ®æº: {', '.join(meta.get('data_sources', []))}")
          print(f"### æ”¯æŒåè®®: {', '.join(meta.get('protocols', []))}")
          print("")
          print("### å„åœ°åŒºèŠ‚ç‚¹åˆ†å¸ƒ:")
          print("")
          print("| åœ°åŒº | èŠ‚ç‚¹æ•° |")
          print("|------|--------|")
          for region, count in sorted(regions.items()):
              print(f"| {region} | {count} |")
          EOF
          else
            echo "âš ï¸ æœªæ‰¾åˆ° JSON æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Publish to GitHub Pages
        if: github.event.inputs.test_mode != 'true' && success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true
          commit_message: 'Deploy: ${{ github.run_number }} [${{ github.sha }}]'

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
          fi